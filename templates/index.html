<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prelievo Sicuro</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 700px;
      margin: 40px auto;
      padding: 0 20px;
      background: #f9f9f9;
      color: #333;
    }
    h1, h2 { text-align: center; }
    .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .section { margin: 30px 0; }
    label { display: block; margin: 10px 0 5px; font-weight: 500; }
    input, .StripeElement {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .StripeElement {
      height: 40px;
      background: white;
    }
    .error {
      color: #dc2626;
      font-size: 14px;
      margin-top: 6px;
    }
    button {
      width: 100%;
      padding: 14px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 12px 0;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #4338ca;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    #result, #production-result {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      font-weight: 500;
    }
    .success { background: #ecfdf5; color: #065f46; }
    .error-box { background: #fef2f2; color: #991b1b; }
    .info { background: #eff6ff; color: #1e40af; }
    .loading { opacity: 0.6; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Prelievo Sicuro</h1>
    <p style="text-align:center;">Utente: <strong>{{ user }}</strong></p>
    <p style="text-align:center;">Saldo attuale: <strong>€ {{ balance|default(0.0)|round(2) }}</strong></p>

    <div class="section">
      <h2>1. Configura metodo di prelievo</h2>
      <div style="margin-bottom: 20px;">
        <label>
          <input type="radio" name="method" value="card" checked> Carta di debito/credito
        </label>
        <label>
          <input type="radio" name="method" value="sepa"> Bonifico SEPA (IBAN)
        </label>
      </div>

      <!-- Form Carta -->
      <form id="card-form">
        <div id="card-element" class="StripeElement"></div>
        <div id="card-errors" class="error" role="alert"></div>
        <button type="submit" id="card-btn">Salva Carta</button>
      </form>

      <!-- Form IBAN/SEPA -->
      <form id="sepa-form" style="display: none;">
        <div id="iban-element" class="StripeElement"></div>
        <input id="sepa-name" placeholder="Nome intestatario" required>
        <input id="sepa-email" type="email" placeholder="Email (opzionale)">
        <div id="sepa-errors" class="error" role="alert"></div>
        <button type="submit" id="sepa-btn">Salva IBAN</button>
      </form>

      <div id="result"></div>
    </div>

    <hr>

    <div class="section">
      <h2>2. Avvia produzione e prelievo</h2>
      <label>Importo per ciclo (€):
        <input id="amount" type="number" value="1000000" step="1000" min="1">
      </label>
      <label>Numero cicli:
        <input id="cycles" type="number" value="5" min="1">
      </label>
      <button onclick="startProduction()" id="start-btn">Avvia Produzione + Prelievo</button>

      <div id="production-result"></div>
    </div>
  </div>

  <script>
    // ================== INIZIALIZZAZIONE STRIPE ==================
    const stripe = Stripe("{{ stripe_pk }}");
    const elements = stripe.elements();

    // Card Element
    const cardElement = elements.create("card", {
      style: { base: { fontSize: "16px", color: "#32325d" } }
    });
    cardElement.mount("#card-element");

    // IBAN Element
    const ibanElement = elements.create("iban", {
      supportedCountries: ["SEPA"],
      style: { base: { fontSize: "16px", color: "#32325d" } }
    });
    ibanElement.mount("#iban-element");

    // Switch tra form carta e IBAN
    document.querySelectorAll('input[name="method"]').forEach(radio => {
      radio.addEventListener("change", function() {
        document.getElementById("card-form").style.display = this.value === "card" ? "block" : "none";
        document.getElementById("sepa-form").style.display = this.value === "sepa" ? "block" : "none";
      });
    });

    // Funzione helper per mostrare messaggi
    function showMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = isError ? "error-box" : "success";
      el.style.display = "block";
    }

    // Funzione loading
    function setLoading(btnId, isLoading) {
      const btn = document.getElementById(btnId);
      btn.disabled = isLoading;
      btn.textContent = isLoading ? "Attendere..." : (btnId.includes("card") ? "Salva Carta" : "Salva IBAN");
    }

    // ================== SALVATAGGIO METODO DI PAGAMENTO ==================
    async function savePaymentMethod(pmId, type, btnId, errorId) {
      setLoading(btnId, true);

      try {
        const response = await fetch("/api/save-payment-method", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            payment_method_id: pmId,
            method_type: type
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          showMessage("result", `Metodo ${type} salvato con successo! ID: ${pmId}`);
        } else {
          showMessage("result", `Errore: ${data.error || "Risposta non valida"}`, true);
        }
      } catch (err) {
        showMessage("result", `Errore di connessione: ${err.message}`, true);
      } finally {
        setLoading(btnId, false);
      }
    }

    // Form CARTA
    document.getElementById("card-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btnId = "card-btn";
      setLoading(btnId, true);

      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: "card",
        card: cardElement
      });

      if (error) {
        document.getElementById("card-errors").textContent = error.message;
        setLoading(btnId, false);
      } else {
        await savePaymentMethod(paymentMethod.id, "card", btnId, "card-errors");
      }
    });

    // Form IBAN/SEPA
    document.getElementById("sepa-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btnId = "sepa-btn";
      setLoading(btnId, true);

      const name = document.getElementById("sepa-name").value.trim();
      const email = document.getElementById("sepa-email").value.trim();

      if (!name) {
        document.getElementById("sepa-errors").textContent = "Il nome intestatario è obbligatorio";
        setLoading(btnId, false);
        return;
      }

      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: "sepa_debit",
        sepa_debit: ibanElement,
        billing_details: { name, email: email || undefined }
      });

      if (error) {
        document.getElementById("sepa-errors").textContent = error.message;
        setLoading(btnId, false);
      } else {
        await savePaymentMethod(paymentMethod.id, "sepa", btnId, "sepa-errors");
      }
    });

    // ================== AVVIA PRODUZIONE E PRELIEVO ==================
    async function startProduction() {
      const result = document.getElementById("production-result");
      result.innerHTML = "<div class='info'>Produzione e prelievo in corso...</div>";

      const amount = parseFloat(document.getElementById("amount").value) || 1000000;
      const cycles = parseInt(document.getElementById("cycles").value) || 5;

      try {
        const response = await fetch("/api/start-production", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount_per_cycle: amount,
            cycles: cycles
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          result.innerHTML = `
            <div class="success">
              <strong>Operazione completata con successo!</strong><br>
              Prelievo eseguito<br>
              Importo: €${data.amount.toFixed(2)}<br>
              Payout ID: ${data.payout_id}<br>
              Stato: ${data.status}
            </div>`;
        } else {
          result.innerHTML = `
            <div class="error-box">
              <strong>Errore:</strong> ${data.error || "Risposta non valida dal server"}
            </div>`;
        }
      } catch (err) {
        result.innerHTML = `
          <div class="error-box">
            <strong>Errore di connessione:</strong> ${err.message}
          </div>`;
      }
    }
  </script>
</body>
</html>
